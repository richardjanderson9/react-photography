#
# Path: nginx.conf
# Description: Nginx configuration for serving a React (Vite) application in Docker.
# Author: Richard Anderson.
# Last Updated: 30-October-2025.
# Version: 1.1.5
# Notes:
#   - Optimized for Docker deployment with Cloudflare caching.
#   - Supports client-side routing with React Router.
#   - Enables gzip and Brotli compression as a fallback.
#   - Adds security headers for enhanced protection.
#

server {
    listen 80 http2; # Enable HTTP/2 for better performance.

    # Enable gzip and Brotli compression for supported file types.
    gzip on;
    gzip_types text/plain text/css application/json application/javascript image/svg+xml;
    brotli on;
    brotli_types text/plain text/css application/json application/javascript image/svg+xml;

    # Add security headers.
    add_header X-Content-Type-Options "nosniff";
    add_header X-Frame-Options "SAMEORIGIN";
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header Referrer-Policy "no-referrer-when-downgrade";
    add_header Content-Security-Policy "default-src 'self'; script-src 'self'; style-src 'self'; img-src 'self' data:; font-src 'self';";

    # Main application route.
    location / {
        root /etc/nginx/html;
        index index.html;
        # Fallback to index.html for client-side routing (React Router).
        try_files $uri $uri/ /index.html;
    }

    # Disable logging for static assets and set long cache expiration.
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|webp|woff|woff2|ttf|eot|json|map)$ {
        access_log off;
        expires 1y;
        add_header Cache-Control "public, max-age=31536000, immutable";
    }

    # Handle large client requests.
    client_max_body_size 10M;

    # Custom error pages.
    error_page 404 /index.html; # Redirect 404 errors to React Router
    error_page 500 502 503 504 /50x.html;

    location = /50x.html {
        root /etc/nginx/html;
        internal;
    }
}